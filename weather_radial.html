<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">

    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>

    <!-- Google Font -->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300,400' rel='stylesheet' type='text/css'>

    <!-- jQuery.js -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <style>
      body {
        font-size: 10px;
        font-family: 'Open Sans', sans-serif;
        font-weight: 400;
        fill: #8C8C8C;
        text-align: center;
      }

      .title {
        text-anchor: middle;
        font-size: 16px;
        fill: #5E5E5E;
      }

      .city {
        text-anchor: middle;
        font-size: 24px;
        fill: #5E5E5E;
      }

      .year {
        text-anchor: middle;
        font-size: 12px;
        font-weight: 300;
        fill: #D3D3D3;
      }

      .firstDay {
        font-size: 10px;
        text-anchor: start;
        font-weight: 300;
        fill: #D3D3D3;
      }

      .yearLine {
        stroke: #C4C4C4;
      }

      .axisText {
        fill: #D3D3D3;
        font-size: 10px;
        font-weight: 300;
        text-anchor: middle;
        text-shadow: 0 1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff, 0 -1px 0 #fff;
      }

      .axisCircles {
        fill: none;
        stroke: #F0F0F0;
        stroke-width: 1px;
      }

      .legendText {
        font-size: 10px;
        font-weight: 400;
        fill: #8C8C8C;
        text-align: center;
      }
    </style>
    <title>Weather Radial</title>
  </head>

  <body>
    <div id="chart"></div>
    <script>
      var DARK_SKY_KEY = "c8403cdd7a9862ddb3113c168336bde8";
      var lat = "39.985977";
      var lon = "-0.037478";
      var first_day_epoch = 1514764800;
      var number_of_days = 31;

      var temperature_data_promises = [];

      for (var i = 0; i < number_of_days; i++) {
        // Calculate epoch by adding seconds to first day epoch
        var epoch = first_day_epoch + (i * 24 * 60 * 60);
        var api_url = `https://api.darksky.net/forecast/${DARK_SKY_KEY}/` +
          `${lat},${lon},${epoch}?units=si`;

        var day_data = $.getJSON(api_url);
        temperature_data_promises.push(day_data);
      };

      Promise.all(temperature_data_promises).then(function(api_data) {
        var temperature_data = [];

        api_data.forEach(function(api_data) {
          var hours = api_data.hourly.data;
          var mean_temp = hours.reduce((sum, hour) => { return sum + hour.temperature; }, 0) / 24;

          var parsed_data = {
            min_temp: api_data.daily.data[0].temperatureMin,
            mean_temp: mean_temp,
            max_temp: api_data.daily.data[0].temperatureMax,
            date: new Date(api_data.daily.data[0].time * 1000),
          };

          temperature_data.push(parsed_data);
        })

        build_chart(temperature_data);
      });

      function build_chart(tempData) {
        // This design is based on the amazing work of http://www.weather-radials.com/
        // And is only meant as a nice example of how you can use an SVG gradient as a legend

        ///////////////////////////////////////////////////
        //////////////// Set the Scales ///////////////////
        ///////////////////////////////////////////////////

        // Set the dimensions of the chart
        var margin = { top: 30, right: 30, bottom: 30, left: 50 },
          width = 600 - margin.left - margin.right,
          height = 600 - margin.top - margin.bottom;

        var parseDate = d3.time.format("%Y-%m-%d").parse;

        // Set the minimum inner radius and max outer radius of the chart
        var innerRadius = 80,
          outerRadius = 200;

        // Base the color scale on average temperature extremes
        var min_average_temperature = Math.round(d3.min(tempData, function(d) { return d.mean_temp; }));
        var max_average_temperature = Math.round(d3.max(tempData, function(d) { return d.mean_temp; }));
        var colorScale = d3.scale.linear()
          .domain([min_average_temperature, max_average_temperature])
          .range(["#2c7bb6", "#d7191c"]);

        // Scale for the heights of the bar, not starting at zero to give the bars an initial offset outward
        var barScale = d3.scale.linear()
          .range([innerRadius, outerRadius]);

        // Scale to turn the date into an angle of 360 degrees in total
        // With the first datapoint (Jan 1st) on top
        var angle = d3.scale.linear()
          .range([-180, 180]);

        ///////////////////////////////////////////////////
        ////////////// Initialize the SVG /////////////////
        ///////////////////////////////////////////////////

        // Add the svg canvas for the line chart
        var svg = d3.select("#chart")
          .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + (margin.left + width / 2) + "," + margin.top + ")");

        // Add a title to explain the gradient
        svg.append("text")
          .attr("class", "title")
          .attr("x", 0)
          .attr("y", 0)
          .text("Weather Radial");

        ///////////////////////////////////////////////////
        ///////// Create the Temperature circle ///////////
        ///////////////////////////////////////////////////

        // Set the bar and angle domains
        barScale.domain([d3.min(tempData, function(d) { return d.min_temp; }), d3.max(tempData, function(d) { return d.max_temp; })]);
        angle.domain([1, number_of_days + 1]);

        // Wrapper for the bars and to position it downward
        var nineColorBarWrapper = svg.append("g")
          .attr("transform", "translate(" + 0 + "," + (outerRadius + 10) + ")");

        // Draw gridlines below the bars
        var axes = nineColorBarWrapper.selectAll(".gridCircles")
          .data([0, 5, 10, 15, 20])
          .enter().append("g");
        // Draw the circles
        axes.append("circle")
          .attr("class", "axisCircles")
          .attr("r", function(d) { return barScale(d); });
        // Draw the axis labels
        axes.append("text")
          .attr("class", "axisText")
          .attr("y", function(d) { return barScale(d); })
          .attr("dy", "0.3em")
          .text(function(d) { return d + "°C" });

        // Add a small title to explain
        nineColorBarWrapper.append("text")
          .attr("class", "city")
          .attr("x", 0)
          .attr("y", 0)
          .text("Castellón");
        // Add subtitle for month
        nineColorBarWrapper.append("text")
          .attr("class", "year")
          .attr("x", 0)
          .attr("y", 22)
          .text("January, 2018");

        // Add January 1st for reference
        nineColorBarWrapper.append("text")
          .attr("class", "firstDay")
          .attr("x", 5)
          .attr("y", -outerRadius * 0.91)
          .text("1st");
        // Add a line to split the year
        nineColorBarWrapper.append("line")
          .attr("class", "yearLine")
          .attr("x1", 0)
          .attr("y1", -innerRadius * 0.9)
          .attr("x2", 0)
          .attr("y2", -outerRadius * 0.95);

        // Draw a bar per day where the height is the difference between the minimum and maximum temperature
        // And the color is based on the mean temperature
        nineColorBarWrapper.selectAll(".tempBar")
          .data(tempData)
          .enter().append("rect")
          .attr("class", "tempBar")
          .attr("transform", function(d, i) { return "rotate(" + (angle(d.date.getDate())) + ")"; })
          .attr("width", 7)
          .attr("height", function(d, i) { return barScale(d.max_temp) - barScale(d.min_temp); })
          .attr("x", -0.5)
          .attr("y", function(d, i) { return barScale(d.min_temp); })
          .attr("rx", 10)
          .style("fill", function(d) { return colorScale(d.mean_temp); })
          .style("stroke", function(d) { return colorScale(d.mean_temp); })
          .on("mouseover", function() {
            d3.select(this).style("stroke-width", "4")
          })
          .on("mouseout", function() {
            d3.select(this).style("stroke-width", "1")
          })
          .append("svg:title")
          .text(function(d) {
            var date = d.date.getDate();
            var max = Math.round(d.max_temp * 10) / 10;
            var min = Math.round(d.min_temp * 10) / 10;
            var mean = Math.round(d.mean_temp * 10) / 10;
            return `January ${date} –– min ${min}°C / mean ${mean}°C / max ${max}°C`;
          });

        ///////////////////////////////////////////////////
        ///////////// Create the gradient ////////////////
        ///////////////////////////////////////////////////

        // Create a linear gradient with multiple colors
        svg.append("defs")
          .append("linearGradient")
          .attr("id", "legendGradientTwo")
          .attr("x1", "0%").attr("y1", "0%")
          .attr("x2", "100%").attr("y2", "0%")
          .selectAll("stop")
          .data([
            { offset: "0%", color: "#2c7bb6" },
            { offset: "100%", color: "#d7191c" }
          ])
          .enter().append("stop")
          .attr("offset", function(d) { return d.offset; })
          .attr("stop-color", function(d) { return d.color; });

        ///////////////////////////////////////////////////
        /////////////// Create the Legend /////////////////
        ///////////////////////////////////////////////////

        var legendWidth = 400;

        // Create a wrapper for the legend
        var legendWrapper = svg.append("g")
          .attr("class", "legendWrapper")
          .attr("transform", "translate(0," + (2 * outerRadius + 40) + ")");

        // Data for the legend text
        var legendText = [
          { x: -legendWidth / 2, y: 30, text: min_average_temperature + "°C", anchor: "start" },
          { x: 0, y: 0, text: "Average temperature", anchor: "middle" },
          { x: legendWidth / 2, y: 30, text: max_average_temperature + "°C", anchor: "end" }
        ];

        // Draw the rectangle and fill with the gradient
        legendWrapper.append("rect")
          .attr("class", "legend")
          .attr("x", -legendWidth / 2)
          .attr("y", 10)
          .attr("rx", 4)
          .attr("width", legendWidth)
          .attr("height", 8)
          .style("fill", "url(#legendGradientTwo)");

        // Append the text along the legend
        legendWrapper.selectAll(".legendText")
          .data(legendText)
          .enter().append("text")
          .attr("class", "legendText")
          .attr("x", function(d) { return d.x; })
          .attr("y", function(d) { return d.y; })
          .style("text-anchor", function(d) { return d.anchor; })
          .text(function(d) { return d.text; });

      };
    </script>
  </body>

</html>
